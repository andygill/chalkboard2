module Main where

import Graphics.ChalkBoard
import Graphics.ChalkBoard.Video
import Graphics.ChalkBoard.Shader
import Control.Concurrent
import Graphics.ChalkBoard.CBIR
import qualified Graphics.Rendering.OpenGL as GL hiding (uniform,scale)

main = startChalkBoard [BoardSize 500 500] videoMain

mkMix :: IO (Board RGB -> Board RGB -> Board Bool -> Board RGB)
mkMix = do 
	fileContents <- readFile "foo.fs"
	return $ \ b1 b2 b3 -> gslBoard fileContents
				[ ("sampler0",board b2)
				, ("sampler1",board b1)
				, ("sampler2",board b3)
				]
				[ ]
				
videoMain cb = do
    foo <- mkMix
    str <- readFile "bar.fs"
    let back = boardOf yellow
	front = boardOf red
	
    (x,y,imgBrd) <- readBoard ("../test1/images/cb-text.png")
    let xy = fromIntegral $ max x y
    let sc = 1 / xy
    let xd = fromIntegral y / xy
    let yd = fromIntegral x / xy
    let img = unAlpha <$> move (-0.5 * yd,-0.5 * xd)  (scale sc imgBrd)

    let loop 500 = exitChalkBoard cb
	loop n  = do
	  let brd = id
		$ foo (rotate (-n) img) (rotate n img) (scale n circle)
	  drawRawChalkBoard cb (example str)
--    	  drawChalkBoard cb (brd)
--  	  threadDelay (1000 * 1000)
	  _ <- getLine
          loop (n - 0.01)
	
    loop 1

example str = 
 [ AllocFragmentShader 1004 str []
	-- "// laplacian.fs\n//\n// Laplacian edge detection\n\nuniform sampler2D sampler0;\n\nvoid main(void)\n{\n//\tgl_FragColor.rgb = texture2D(sampler0,gl_TexCoord[0].st).rgb;\n\n\tif (texture2D(sampler0,gl_TexCoord[0].st).r >= 0.5) { \n\t\tgl_FragColor.rgb = vec3(1.0,0.0,0.0);\n\t} else {\n\t\tgl_FragColor.rgb = vec3(0.0,1.0,0.0);\n\t}\n\t\n        gl_FragColor.a = 1.0;\n}\n" []
 , Allocate 1001 (500,500) RGB24Depth (BackgroundG8Bit 0.5)
 , Nested "BOOL -> RGB"
     [ Allocate 1002 (1,1) RGB24Depth (BackgroundG8Bit 0.5)
     , Allocate 1003 (1,1) RGB24Depth (BackgroundG8Bit 0.5)
     , CopyBuffer WithSrcAlpha 1002 1001
     , Nested "precision factor = 501.0"
         [ SplatColor (RGBA 1.0 1.0 1.0 1.0) 1001 False [(0.5,1.0),(0.50627047,0.99996066),(0.51254,0.99984276),(0.5188075,0.9996462),(0.52507204,0.999371),(0.5313327,0.9990173),(0.53758836,0.9985851),(0.54383814,0.99807453),(0.550081,0.9974856),(0.556316,0.9968184),(0.5625422,0.99607307),(0.5687585,0.9952497),(0.574964,0.99434847),(0.5811577,0.99336946),(0.5873387,0.9923129),(0.59350586,0.9911789),(0.59965837,0.9899676),(0.6057952,0.98867923),(0.61191535,0.987314),(0.618018,0.98587215),(0.624102,0.9843539),(0.6301665,0.9827595),(0.6362105,0.98108906),(0.64223313,0.97934306),(0.64823335,0.9775216),(0.65421027,0.97562504),(0.6601629,0.9736537),(0.6660904,0.97160786),(0.67199177,0.96948785),(0.6778661,0.967294),(0.6837124,0.9650266),(0.68952984,0.9626861),(0.69531745,0.96027285),(0.70107436,0.95778716),(0.7067996,0.9552295),(0.7124924,0.95260024),(0.71815175,0.9498998),(0.72377676,0.94712853),(0.72936654,0.94428706),(0.7349203,0.9413756),(0.74043715,0.9383948),(0.7459161,0.935345),(0.7513564,0.9322268),(0.75675714,0.9290405),(0.76211756,0.92578673),(0.76743674,0.92246604),(0.77271384,0.91907895),(0.777948,0.91562593),(0.7831385,0.91210747),(0.7882845,0.9085243),(0.7933851,0.90487677),(0.79843956,0.9011656),(0.8034471,0.8973913),(0.80840695,0.89355457),(0.8133182,0.8896559),(0.8181802,0.88569593),(0.8229922,0.8816753),(0.8277534,0.87759465),(0.832463,0.8734546),(0.8371203,0.8692559),(0.84172463,0.864999),(0.8462752,0.86068475),(0.8507713,0.85631377),(0.8552122,0.85188675),(0.8595973,0.84740436),(0.8639258,0.8428673),(0.8681971,0.8382764),(0.8724104,0.83363223),(0.8765652,0.8289356),(0.8806608,0.8241873),(0.8846965,0.8193879),(0.88867164,0.81453836),(0.89258564,0.80963933),(0.896438,0.80469155),(0.9002279,0.79969585),(0.9039549,0.79465306),(0.9076184,0.7895639),(0.91121775,0.7844292),(0.9147524,0.7792498),(0.91822183,0.7740264),(0.9216255,0.76875997),(0.9249629,0.7634512),(0.9282334,0.7581011),(0.93143654,0.75271034),(0.93457186,0.7472798),(0.93763876,0.74181044),(0.94063693,0.736303),(0.9435657,0.7307584),(0.9464248,0.7251775),(0.9492136,0.7195612),(0.95193183,0.71391034),(0.9545789,0.70822585),(0.9571545,0.7025086),(0.9596582,0.6967596),(0.96208966,0.69097954),(0.96444833,0.68516946),(0.96673405,0.6793303),(0.9689463,0.6734629),(0.97108483,0.66756827),(0.9731492,0.6616472),(0.97513926,0.65570074),(0.9770545,0.6497298),(0.9788947,0.6437353),(0.9806596,0.6377182),(0.982349,0.6316794),(0.9839624,0.62561995),(0.98549974,0.6195407),(0.98696077,0.61344266),(0.98834515,0.6073268),(0.9896527,0.601194),(0.99088323,0.5950454),(0.9920366,0.58888173),(0.99311256,0.5827041),(0.994111,0.5765135),(0.9950317,0.5703109),(0.9958745,0.56409717),(0.9966394,0.55787337),(0.99732614,0.5516405),(0.9979346,0.54539955),(0.9984648,0.53915143),(0.9989166,0.5328971),(0.99928993,0.5266376),(0.99958473,0.52037394),(0.9998009,0.51410705),(0.9999386,0.50783795),(0.99999756,0.50156766),(0.9999779,0.49529707),(0.9998796,0.48902723),(0.9997027,0.48275912),(0.9994471,0.47649372),(0.9991131,0.470232),(0.9987005,0.463975),(0.9982095,0.45772365),(0.99764013,0.45147896),(0.99699247,0.44524187),(0.9962667,0.43901342),(0.99546283,0.43279454),(0.99458104,0.42658624),(0.99362147,0.4203895),(0.9925843,0.4142053),(0.9914696,0.4080346),(0.99027765,0.40187833),(0.98900855,0.39573747),(0.9876625,0.38961303),(0.9862398,0.38350597),(0.9847406,0.3774172),(0.98316514,0.37134773),(0.98151374,0.3652985),(0.97978663,0.35927045),(0.97798395,0.3532645),(0.97610617,0.3472817),(0.9741535,0.34132284),(0.97212625,0.335389),(0.97002476,0.329481),(0.9678493,0.32359987),(0.9656003,0.31774646),(0.96327806,0.31192172),(0.9608829,0.30612653),(0.9584153,0.30036187),(0.95587564,0.29462862),(0.95326424,0.28892767),(0.95058155,0.28325993),(0.947828,0.27762622),(0.945004,0.27202752),(0.94211,0.26646468),(0.93914646,0.26093856),(0.93611383,0.25545),(0.9330127,0.24999997),(0.9298434,0.24458924),(0.92660654,0.23921868),(0.92330253,0.23388913),(0.9199319,0.22860143),(0.9164953,0.22335643),(0.9129932,0.21815494),(0.9094261,0.21299776),(0.9057946,0.20788571),(0.90209925,0.20281965),(0.8983407,0.19780031),(0.89451957,0.19282848),(0.8906363,0.18790498),(0.8866916,0.18303058),(0.8826861,0.17820603),(0.8786204,0.17343208),(0.87449515,0.16870949),(0.87031096,0.16403902),(0.8660686,0.15942138),(0.8617686,0.15485731),(0.85741174,0.15034753),(0.8529986,0.14589274),(0.84853005,0.14149362),(0.8440066,0.13715091),(0.8394291,0.13286528),(0.83479816,0.12863737),(0.83011466,0.12446797),(0.8253792,0.12035754),(0.8205925,0.11630684),(0.8157554,0.11231646),(0.8108686,0.10838708),(0.805933,0.10451928),(0.8009492,0.1007137),(0.7959181,9.6970886e-2),(0.7908405,9.329149e-2),(0.7857171,8.967605e-2),(0.7805488,8.6125165e-2),(0.7753363,8.263937e-2),(0.77008057,7.921919e-2),(0.7647823,7.586521e-2),(0.75944245,7.257792e-2),(0.75406176,6.93579e-2),(0.74864113,6.620559e-2),(0.74318135,6.31215e-2),(0.73768336,6.010613e-2),(0.73214793,5.715993e-2),(0.7265761,5.428341e-2),(0.72096854,5.1476985e-2),(0.71532625,4.8741072e-2),(0.7096501,4.607618e-2),(0.703941,4.348266e-2),(0.69819975,4.0960938e-2),(0.6924274,3.8511425e-2),(0.6866247,3.613448e-2),(0.68079275,3.3830523e-2),(0.6749323,3.159985e-2),(0.6690444,2.9442877e-2),(0.6631298,2.7359903e-2),(0.6571896,2.5351256e-2),(0.65122473,2.3417294e-2),(0.645236,2.1558255e-2),(0.63922447,1.9774497e-2),(0.633191,1.8066227e-2),(0.62713665,1.6433805e-2),(0.6210623,1.4877409e-2),(0.61496884,1.3397306e-2),(0.60885733,1.1993766e-2),(0.60272866,1.0666966e-2),(0.596584,9.417146e-3),(0.59042406,8.244485e-3),(0.58424985,7.14916e-3),(0.5780624,6.131321e-3),(0.57186264,5.191177e-3),(0.56565166,4.3288767e-3),(0.55943024,3.5445094e-3),(0.5531996,2.838254e-3),(0.5469605,2.21017e-3),(0.540714,1.6603768e-3),(0.5344612,1.1889935e-3),(0.5282029,7.9604983e-4),(0.5219402,4.8160553e-4),(0.515674,2.4572015e-4),(0.5094054,8.8483095e-5),(0.50313526,9.834766e-6),(0.49686465,9.834766e-6),(0.49059454,8.8483095e-5),(0.48432592,2.4574995e-4),(0.47805974,4.8160553e-4),(0.47179702,7.9604983e-4),(0.46553874,1.1889935e-3),(0.45928589,1.6604066e-3),(0.4530394,2.21017e-3),(0.44680035,2.838254e-3),(0.44056964,3.5445392e-3),(0.4343483,4.3288767e-3),(0.42813724,5.191207e-3),(0.42193753,6.131351e-3),(0.4157501,7.14916e-3),(0.40957588,8.244485e-3),(0.4034159,9.417176e-3),(0.3972711,1.0666996e-2),(0.3911425,1.1993825e-2),(0.38503098,1.3397366e-2),(0.37893754,1.4877468e-2),(0.37286317,1.6433835e-2),(0.36680877,1.8066287e-2),(0.36077535,1.9774526e-2),(0.3547638,2.1558315e-2),(0.3487751,2.3417354e-2),(0.34281018,2.5351316e-2),(0.33686998,2.7359962e-2),(0.33095556,2.9442906e-2),(0.32506764,3.159988e-2),(0.3192072,3.3830553e-2),(0.31337517,3.613451e-2),(0.30757254,3.8511455e-2),(0.30180016,4.0960968e-2),(0.29605895,4.348269e-2),(0.29034984,4.607621e-2),(0.2846737,4.8741132e-2),(0.2790314,5.1477015e-2),(0.27342385,5.428344e-2),(0.26785195,5.715999e-2),(0.26231658,6.010616e-2),(0.2568186,6.312153e-2),(0.2513588,6.620562e-2),(0.24593818,6.935793e-2),(0.24055749,7.257798e-2),(0.2352176,7.586527e-2),(0.22991937,7.921925e-2),(0.22466362,8.2639396e-2),(0.21945116,8.6125195e-2),(0.21428284,8.967611e-2),(0.20915943,9.329155e-2),(0.2040818,9.6970946e-2),(0.1990507,0.10071373),(0.19406691,0.10451934),(0.18913126,0.10838714),(0.18424451,0.11231652),(0.17940742,0.1163069),(0.17462075,0.1203576),(0.16988525,0.12446803),(0.1652017,0.12863752),(0.16057077,0.13286543),(0.15599325,0.13715106),(0.15146983,0.14149377),(0.1470012,0.14589286),(0.14258814,0.15034768),(0.13823125,0.15485746),(0.13393128,0.15942153),(0.12968889,0.16403916),(0.12550473,0.16870964),(0.121379584,0.17343214),(0.11731386,0.17820609),(0.11330837,0.18303064),(0.109363675,0.18790504),(0.1054804,0.19282857),(0.10165921,0.19780037),(9.790066e-2,0.2028197),(9.420535e-2,0.2078858),(9.057388e-2,0.21299782),(8.700678e-2,0.218155),(8.350465e-2,0.22335649),(8.006802e-2,0.22860152),(7.669747e-2,0.23388919),(7.3393464e-2,0.23921874),(7.0156574e-2,0.2445893),(6.6987276e-2,0.25000006),(6.3886076e-2,0.25545013),(6.085348e-2,0.26093864),(5.788997e-2,0.26646477),(5.4995984e-2,0.2720276),(5.2171975e-2,0.2776263),(4.941842e-2,0.28326),(4.6735704e-2,0.28892776),(4.4124305e-2,0.29462874),(4.158461e-2,0.300362),(3.911701e-2,0.30612668),(3.6721885e-2,0.31192183),(3.439963e-2,0.31774658),(3.2150626e-2,0.3236),(2.9975176e-2,0.32948115),(2.7873695e-2,0.33538914),(2.5846422e-2,0.34132302),(2.3893744e-2,0.3472818),(2.2015959e-2,0.35326466),(2.0213336e-2,0.35927057),(1.8486202e-2,0.36529863),(1.6834766e-2,0.37134787),(1.5259355e-2,0.37741736),(1.3760179e-2,0.38350612),(1.2337476e-2,0.38961318),(1.0991454e-2,0.39573762),(9.722352e-3,0.40187848),(8.530378e-3,0.40803474),(7.415682e-3,0.41420546),(6.378472e-3,0.4203897),(5.4189265e-3,0.42658645),(4.5371354e-3,0.43279475),(3.7332773e-3,0.4390136),(3.0074716e-3,0.44524208),(2.3598373e-3,0.45147914),(1.7904639e-3,0.45772386),(1.2994707e-3,0.4639752),(8.869171e-4,0.47023222),(5.528331e-4,0.47649392),(2.9733777e-4,0.48275933),(1.2040138e-4,0.48902744),(2.2113323e-5,0.49529728),(2.4437904e-6,0.50156784),(6.145239e-5,0.5078382),(1.9904971e-4,0.5141073),(4.1526556e-4,0.5203741),(7.1007013e-4,0.5266378),(1.0834038e-3,0.5328973),(1.535207e-3,0.5391516),(2.0653903e-3,0.5453998),(2.673924e-3,0.55164075),(3.360629e-3,0.5578734),(4.125476e-3,0.5640972),(4.9683154e-3,0.5703109),(5.8889985e-3,0.5765135),(6.887406e-3,0.5827042),(7.963389e-3,0.5888818),(9.116739e-3,0.5950454),(1.0347307e-2,0.6011941),(1.1654884e-2,0.60732687),(1.3039261e-2,0.6134427),(1.450026e-2,0.61954075),(1.6037583e-2,0.62562),(1.7651051e-2,0.6316795),(1.9340366e-2,0.6377182),(2.110529e-2,0.64373535),(2.2945523e-2,0.64972985),(2.48608e-2,0.6557008),(2.685079e-2,0.66164726),(2.8915226e-2,0.66756827),(3.1053722e-2,0.673463),(3.3266008e-2,0.67933035),(3.5551697e-2,0.6851696),(3.79104e-2,0.6909796),(4.0341824e-2,0.69675964),(4.2845517e-2,0.70250875),(4.5421124e-2,0.70822597),(4.8068225e-2,0.71391046),(5.0786406e-2,0.7195613),(5.3575248e-2,0.7251776),(5.6434304e-2,0.7307585),(5.9363127e-2,0.7363031),(6.236124e-2,0.7418105),(6.54282e-2,0.7472799),(6.856349e-2,0.7527104),(7.1766675e-2,0.75810117),(7.503718e-2,0.76345134),(7.8374535e-2,0.7687601),(8.17782e-2,0.7740265),(8.5247636e-2,0.77924985),(8.878231e-2,0.7844293),(9.2381686e-2,0.789564),(9.604514e-2,0.7946532),(9.9772155e-2,0.79969597),(0.10356209,0.8046917),(0.107414395,0.8096394),(0.11132845,0.8145385),(0.115303636,0.81938803),(0.11933932,0.8241874),(0.12343487,0.82893574),(0.12758967,0.83363235),(0.13180304,0.8382765),(0.1360743,0.84286743),(0.1404028,0.8474045),(0.14478788,0.85188687),(0.14922881,0.8563138),(0.15372491,0.8606849),(0.15827549,0.8649991),(0.1628798,0.86925596),(0.16753712,0.8734547),(0.17224675,0.87759477),(0.17700794,0.8816754),(0.18181992,0.88569605),(0.18668193,0.88965595),(0.19159323,0.8935547),(0.19655305,0.89739144),(0.20156059,0.9011657),(0.20661506,0.9048768),(0.21171567,0.9085244),(0.21686164,0.9121076),(0.22205213,0.91562605),(0.22728634,0.91907907),(0.23256344,0.92246616),(0.23788261,0.92578685),(0.24324298,0.9290406),(0.24864376,0.93222684),(0.25408408,0.9353451),(0.25956306,0.9383949),(0.26507986,0.94137573),(0.27063364,0.9442872),(0.27622345,0.94712865),(0.2818485,0.9498999),(0.2875078,0.95260036),(0.29320055,0.95522964),(0.29892585,0.9577873),(0.30468273,0.9602729),(0.31047016,0.9626861),(0.31628758,0.9650266),(0.3221339,0.967294),(0.32800823,0.96948785),(0.33390957,0.97160786),(0.33983707,0.9736537),(0.34578973,0.97562504),(0.35176665,0.9775216),(0.3577669,0.97934306),(0.3637895,0.9810891),(0.36983353,0.9827595),(0.37589803,0.9843539),(0.38198206,0.98587215),(0.38808465,0.987314),(0.39420485,0.98867923),(0.4003417,0.9899676),(0.40649417,0.9911789),(0.41266137,0.9923129),(0.41884235,0.99336946),(0.42503604,0.99434847),(0.43124154,0.99524975),(0.43745786,0.99607307),(0.443684,0.9968184),(0.44991904,0.9974856),(0.45616192,0.99807453),(0.4624117,0.9985851),(0.4686674,0.9990173),(0.47492802,0.999371),(0.4811926,0.9996462),(0.4874601,0.99984276),(0.4937296,0.99996066)]
         ]
     , Delete 1002
     , Delete 1003
     ]
 , Allocate 1005 (1,1) G8BitDepth (BackgroundG8Bit 0.5)
 , SplatWithFunction 1004 [("sampler0",1001)] [] 0 [PointMap (0.0,0.0) (0.0,0.0),PointMap (1.0,0.0) (1.0,0.0),PointMap (1.0,1.0) (1.0,1.0),PointMap (0.0,1.0) (0.0,1.0)]
 , Delete 1001
 ]

